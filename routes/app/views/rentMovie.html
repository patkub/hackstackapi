<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../vendor/bootstrap/css/bootstrap.min.css" />

    <!-- Font Awesome CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
      integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
      crossorigin="anonymous"
    />

    <!-- jQuery -->
    <script src="../vendor/jquery/jquery.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="../static/css/index.css" />
    <script src="../static/js/index.js"></script>

    <title>Hello, world!</title>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="/">Navbar</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link" href="/"
              >Home <span class="sr-only">(current)</span></a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/manageCustomers">Manage Customers</a>
          </li>
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              id="navbarDropdownReports"
              role="button"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
            >
              Add
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownReports">
              <a class="dropdown-item" href="/addMovie">Add a Movie</a>
              <a class="dropdown-item disabled" href="#">Add a Game</a>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              id="navbarDropdownReports"
              role="button"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
            >
              Reports
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownReports">
              <!-- TODO: add route for Inventory Report -->
              <a class="dropdown-item" href="/inventoryReport"
                >Inventory Report</a
              >
              <a class="dropdown-item disabled" href="#">Customer Report</a>
            </div>
          </li>
        </ul>
        <form class="form-inline my-2 my-lg-0">
          <input
            class="form-control mr-sm-2"
            type="search"
            placeholder="Search"
            aria-label="Search"
          />
          <button class="btn btn-outline-success my-2 my-sm-0" type="submit">
            Search
          </button>
        </form>
      </div>
    </nav>

    <div id="alert" class="alert alert-primary d-none" role="alert"></div>

    <h2 class="text-center">Get this Movie!</h2>

    <!-- Big display for movie -->
    <div id="bigmovie" class="container big-movie"></div>

    <script>
      // get the movie id from url
      const movieIDUrl = window.location.href.substring(
        window.location.href.lastIndexOf("/") + 1
      )
      // split out the api ids
      const movieIDParts = movieIDUrl.split(":")
      const imdbID = movieIDParts[0]
      const tmdbID = movieIDParts[1]

      /**
       * Convert genre list into bootstrap badges
       * @param genre {String} tags "Action, Crime, Drama"
       * @return {String} bootstrap tag html
       */
      function getTags(genre) {
        const tags = genre.split(", ")
        let content = ""
        for (const tag of tags) {
          // note: space character after </span> tag is important for spacing
          content +=
            "<span class='badge badge-secondary'><i class='fa fa-tag'></i>" +
            tag +
            "</span> "
        }
        return content
      }

      /**
       * HTML for the credits (actors/actresses)
       */
      function getCredits(credits) {
        let content = ""
        for (const credit of credits) {
          console.log(credit)
          content += [
            "<figure class='figure'>",
            "<img src='https://image.tmdb.org/t/p/original/" +
              credit.profile_path +
              "' alt='actor' class='img-thumbnail figure-img img-fluid rounded' style='height: 75px'>",
            "<figcaption class='figure-caption'>" +
              credit.name +
              "</figcaption>",
            "</figure>",
          ].join("\n")
        }
        return content
      }

      // get movie OMDb api data using imdb id
      $.getJSON("/api/rentalItem/movie/{0}".format(imdbID), function (
        dataOMDB
      ) {
        // now grab the movie backdrop from tmdb
        $.getJSON("/api/rentalItem/movieTMDb/{0}".format(tmdbID), function (
          dataTMDB
        ) {
          // now get the cast from tmdb
          $.getJSON(
            "/api/rentalItem/movieTMDbCredits/{0}".format(tmdbID),
            function (dataTMDBCredits) {
              // keep only first 5 cast members that have a name and picture
              const cast = dataTMDBCredits.cast
                .filter(function (el) {
                  return el.name !== null && el.profile_path !== null
                })
                .slice(0, 5)

              $(
                [
                  "<div class='card mb-3'>",
                  "   <div class='row no-gutters'>",
                  "    <div class='col-md-4 bg-dark'>",
                  "      <img",
                  "       src='" + dataOMDB.poster + "'",
                  "       class='card-img rounded-0'",
                  "       alt='" + dataOMDB.title + " poster'",
                  "      />",
                  "    </div>",
                  "    <div class='col-md-8'>",
                  "      <div class='card-body' style=\"background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://image.tmdb.org/t/p/original" +
                    dataTMDB.backdropPath +
                    "') center center/cover no-repeat #ccc;\">",
                  "        <h5 class='card-title font-weight-bolder'>" +
                    dataOMDB.title +
                    " " +
                    dataOMDB.yearReleased +
                    "</h5>",
                  "        <div class='card-text'>",
                  "          <div class='tags' id='tags'>",
                  getTags(dataOMDB.genre),
                  "          </div>",
                  "          <p class='movie-description'>" +
                    dataOMDB.itemDesc +
                    "</p>",
                  getCredits(cast),
                  "        </div>",
                  "      </div>",
                  "      <ul class='list-group list-group-flush'>",
                  "        <li class='list-group-item list-group-item-dark'>",
                  "          Content Rating: " + dataOMDB.contentRating,
                  "        </li>",
                  "        <li class='list-group-item list-group-item-dark'>",
                  "          Rental Status: " + dataOMDB.rentalStatus,
                  "        </li>",
                  "        <li class='list-group-item list-group-item-warning'>Late:" +
                    dataOMDB.isLate +
                    "</li>",
                  "        <li class='list-group-item list-group-item-danger'>Fine:" +
                    dataOMDB.fine +
                    "</li>",
                  "      </ul>",
                  "      <div class='card-footer bg-dark rounded-0'>",
                  "        <a id='btnRent' href='#' class='btn btn-primary'>Rent</a>",
                  "        <a id='btnReserve' href='#' class='btn btn-secondary'>Reserve</a>",
                  "      </div>",
                  "    </div>",
                  "  </div>",
                  "</div>",
                ].join("\n")
              ).appendTo("#bigmovie")

              $("#btnRent").click(function () {
                //alert( "Rent button clicked" );
                $("#alert")
                  .removeClass("d-none")
                  .html("<strong>You Rented the Movie!</strong>")
              })

              $("#btnReserve").click(function () {
                //alert( "Reserve button clicked" );
                $("#alert")
                  .removeClass("d-none")
                  .html("<strong>You Reserved the Movie!</strong>")
              })
            }
          )
        })
      })
    </script>
  </body>
</html>
